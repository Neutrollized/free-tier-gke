# https://taskfile.dev

version: '3'

vars:
  NAMESPACE: argocd
  RELEASE_NAME: argocd
  VERSION: 9.1.7

tasks:
  default:
    cmds:
      - task --list
    silent: true

  help:
    desc: show all available tasks
    cmds:
      - task --list


  #------------------------------
  # ArgoCD tasks
  #------------------------------
  repo:install:
    desc: adds ArgoCD helm repo
    cmds:
      - helm repo add argocd https://argoproj.github.io/argo-helm
      - helm repo update argocd
    internal: true

  repo:list:
    desc: list available ArgoCD releases
    deps: [repo:install]
    cmds:
      - helm search repo argo-cd -l | head -10

  install:
    desc: install ArgoCD
    deps: [repo:install]
    cmds:
      - |
        helm install {{.RELEASE_NAME}} argocd/argo-cd \
          --create-namespace \
          --namespace {{.NAMESPACE}} \
          --version {{.VERSION}}
    status:
      - kubectl wait --for=condition=Ready pod -l app.kubernetes.io/component=server,app.kubernetes.io/instance=argocd -n {{.NAMESPACE}} --timeout=300s
    internal: true

  argocd:extlb:
    desc: setup external load balancer
    cmds:
      - "kubectl patch svc argocd-server -n argocd -p '{\"spec\": {\"type\": \"LoadBalancer\"}}'"
      - "kubectl wait --for=jsonpath='{.status.loadBalancer.ingress[0].ip}' svc argocd-server -n {{.NAMESPACE}} --timeout=300s"
    status:
      - "kubectl wait --for=jsonpath='{.status.loadBalancer.ingress[0].ip}' svc argocd-server -n {{.NAMESPACE}} --timeout=300s"
    internal: true

  argocd:initpw:
    desc: get initial admin secret
    deps: [install]
    cmds:
      - kubectl -n {{.NAMESPACE}} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

  uninstall:
    desc: uninstall ArgoCD
    cmds:
      - helm uninstall {{.RELEASE_NAME}} -n {{.NAMESPACE}} --keep-history

  all:
    desc: full repo setup and ArgoCD install
    cmds:
      - task: install
      - task: argocd:extlb
      - task: argocd:initpw

  clean:
    desc: purge ArgoCD install
    cmds:
      - helm uninstall {{.RELEASE_NAME}} -n {{.NAMESPACE}}
